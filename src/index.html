<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Messenger 0.2</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

</head>

<body style="height: 100vh;">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socketio = io();

        /* GLOBAL VARIABLES */
        var recipient = 'all';
        var groupRecipient = false;
        var groups = [];
        var messages = [];
        var users = [];
        var typingTimeout;

        /* LOGIN/REGISTRATION FUNCTIONS */

        function login() {
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;

            socketio.on("welcome", (welcomemessage) => {
                messages.push({
                    message: welcomemessage,
                    sender: 'all'
                });
                displayMessages();
                // document.getElementById('messages').innerHTML += welcomemessage + "<br>";
            });

            socketio.emit("login", username, password);
        }

        function register() {
            var username = document.getElementById('newusername').value;
            var password = document.getElementById('newpassword').value;

            socketio.on("welcome", (welcomemessage) => {
                document.getElementById('messages').innerHTML += sanitizeHTML(welcomemessage) + "<br>";
            });

            socketio.emit("register", username, password);
        }

        function logout() {
            socketio.emit("logout");
            hideChatScreen();
            showLoginScreen();
        }

        /* MESSAGING FUNCTIONS */

        function sendmessage() {
            if (recipient === 'all') {
                socketio.emit("chat", document.getElementById('yourmessage').value);
            } else if (groupRecipient) {
                console.log('sending group chat');
                socketio.emit("groupchat", {
                    message: document.getElementById('yourmessage').value,
                    groupName: recipient
                });
            } else {
                console.log('sending private chat');
                socketio.emit("privatechat", {
                    message: document.getElementById('yourmessage').value,
                    socketId: recipient
                });
                console.log('private chat emitted');
            }
        }

        function createGroup() {
            var userSelect = document.getElementById('userSelect');
            var groupName = document.getElementById('groupName').value;
            var selections = [];
            selections = Array.from(userSelect.selectedOptions).map(o => o.value)
            console.log(selections);
            socketio.emit("creategroup", groupName, selections);
        }

        function typing() {
            console.log("typing");
            socketio.emit("typing")
        }

        function displayMessages() {
            var selectedMessages = messages.filter(message => message.sender === recipient);
            var messageWindow = document.getElementById('messages');
            messageWindow.innerHTML = '';
            selectedMessages.forEach(message => {
                messageWindow.innerHTML += sanitizeHTML(message.message) + "<br>";
            });
        }

        function updateUserList() {
            var list = document.getElementById("userList");

            // Create "All" Option
            list.innerHTML = '<div id="all" class="list-group-item border-bottom" data-toggle="list" onclick="selectRecipient(\'all\'); groupRecipient = false;">All Users</div>';

            // Create group options (value = group name)
            groups.forEach(group => {
                var groupLink = '<div id="' + group + '" class="list-group-item" data-toggle="list" onclick="selectRecipient(\'' + group + '\'); groupRecipient = true;">' + group + '</div>';
                list.innerHTML += groupLink;
            });

            // Create user options (value = socketid)
            users.forEach(user => {
                var userLink = '<div id="' + user.id + '" class="list-group-item" data-toggle="list" onclick="selectRecipient(\'' + user.id + '\'); groupRecipient = false;">' + user.username + '</div>';
                list.innerHTML += userLink;
            });

            // Reset which option is selected so it matches recipient value
            var selectedUser = document.getElementById(recipient);
            selectedUser.classList.add('active');
        }


        function selectRecipient(newRecipient) {
            recipient = newRecipient;
            displayMessages();
        }

        /* OTHER FEATURES */

        function toggleDarkMode() {
            var body = document.body;
            var button = document.getElementById('dark-mode');
            var navbar = document.getElementById('navbar');
            var userList = document.getElementById("userList");

            if (body.style.backgroundColor === "black") {
                body.style.backgroundColor = "white";
                body.style.color = "black";
                navbar.classList.remove('bg-dark');
                navbar.classList.remove('navbar-dark');
                navbar.classList.add('bg-light');
                navbar.classList.add('navbar-light');
                userList.style.color = 'rgb(33, 37, 41)';
                button.innerHTML = "Dark Mode";
            } else {
                body.style.backgroundColor = "black";
                body.style.color = "white";
                navbar.classList.remove('bg-light');
                navbar.classList.remove('navbar-light');
                navbar.classList.add('bg-dark');
                navbar.classList.add('navbar-dark');
                userList.style.color = 'rgb(33, 37, 41)';
                button.innerHTML = "Light Mode"
            }
        }

        /* UTILITY FUNCTIONS */

        function hideRegistrationScreen() {
            var registrationScreen = document.getElementById('registrationScreen');
            registrationScreen.style.display = 'none';
        }

        function showRegistrationScreen() {
            var registrationScreen = document.getElementById('registrationScreen');
            registrationScreen.style.display = 'block';
        }

        function hideLoginScreen() {
            var loginScreen = document.getElementById('loginUI');
            loginScreen.style.display = 'none';
            var logoutButton = document.getElementById('logoutbutton');
            logoutButton.style.display = 'block';
        }

        function showLoginScreen() {
            var loginScreen = document.getElementById('loginUI');
            loginScreen.style.display = 'block';
            var logoutButton = document.getElementById('logoutbutton');
            logoutButton.style.display = 'none';
        }

        function hideChatScreen() {
            var chatScreen = document.getElementById('chatUI');
            chatScreen.style.display = 'none';
        }

        function hideMessageForm() {
            var messageForm = document.getElementById('messageForm');
            messageForm.style.display = 'none';
        }

        function showMessageForm() {
            var messageForm = document.getElementById('messageForm');
            messageForm.style.display = 'block';
        }

        function hideGroupForm() {
            var groupForm = document.getElementById('createGroup');
            groupForm.style.display = 'none';
        }

        function showGroupForm() {
            var groupForm = document.getElementById('createGroup');
            groupForm.style.display = 'block';
        }

        //https://gomakethings.com/preventing-cross-site-scripting-attacks-when-using-innerhtml-in-vanilla-javascript/
        /*!
        * Sanitize and encode all HTML in a user-submitted string
        * (c) 2018 Chris Ferdinandi, MIT License, https://gomakethings.com
        * @param  {String} str  The user-submitted string
        * @return {String} str  The sanitized string
        */
        var sanitizeHTML = function (str) {
            var temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };


        /* SOCKET.IO EVENT HANDLING */

        socketio.on("chat", (chatmessage) => {
            // clearTimeout(typingTimeout);
            messages.push(chatmessage);
            displayMessages();
            // document.getElementById('messages').innerHTML += chatmessage.message + "<br>";
        });

        socketio.on("typing", (typingmessage) => {
            // clearTimeout(typingTimeout);
            document.getElementById("typingMessage").innerHTML = typingmessage;
            typingTimeout = setTimeout(() => { document.getElementById("typingMessage").innerHTML = ''; }, 5000);
        });

        socketio.on("newuser", (newusers) => {
            // console.log("new user, users:", users);
            users = newusers;
            console.log(users);
            var select = document.getElementById('userSelect');
            var list = document.getElementById("userList");
            select.innerHTML = '';
            newusers.forEach(user => {
                var userOption = '<option value="' + user.id + '">' + user.username + '</option>';
                select.innerHTML += sanitizeHTML(userOption);
            });
            updateUserList();
        });

        socketio.on("newgroup", (groupName) => {
            groups.push(groupName);
            updateUserList();
        })

        socketio.on("authenticated", () => {
            document.getElementById("loginUI").style.display = "none";
            document.getElementById("chatUI").style.display = "block";
            document.getElementById("messages").innerHTML +=
                "You are successfully logged in! Can start chatting now.<br>";
            document.getElementById('username').value = '';
            password = document.getElementById('password').value = '';
        });

        socketio.on("registration", (result) => {
            var username = document.getElementById('newusername').value;
            if (result === "Success") {
                alert("... You can login now!");
                hideRegistrationScreen();
                showLoginScreen();
                return
            }
            if (result === "UserExist") {
                alert("Username '" + username + "' exists. Please try again.");
            }
            if (result == "invalid login") {
                alert("Username too short and/or insecure password! Please try again.");
            } else {
                alert("User registration error. Please try again.");
            }
            document.getElementById('newusername').value = "";
            document.getElementById('newpassword').value = "";
            document.getElementById('newusername').focus();
        });

        socketio.on("loginfailed", () => {
            alert("Invalid username or password. Please try again.");
        });

        // socketio.on("disconnect", () => {
        //     socketio.emit("logout");
        // })

    </script>

    <!-- NAVBAR -->

    <nav id="navbar" class="navbar navbar-expand-lg navbar-light bg-light sticky-top mb-3">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand pl-3" href="#">Messenger 0.2</a>
        <span class="flex-grow-1"></span>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        </div>
        <button type="button" id="dark-mode" class="btn btn-light" onclick="toggleDarkMode()">Dark
            Mode</button>
    </nav>
    <!-- <h1 id="title" class="pt-3 pl-3">Messenger 0.2</h1> -->

    <!-- REGISTRATION SCREEN -->

    <div id="registrationScreen" class="container" style="display:none;">
        <form class="col-md-6 mx-auto" onsubmit="register(); return false;">
            <h4 class="pb-2">Register an account</h4>
            <div class="form-group">
                <!-- <label>Register your account:</label> -->
                <input type="text" id="newusername" class="form-control" placeholder="Enter a username ...">
            </div>
            <div class="form-group">
                <input type="password" id="newpassword" class="form-control" placeholder="Create your password ...">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Register</button><br>
            </div>
            <a href="#" onclick="hideRegistrationScreen();showLoginScreen()">Already have an account? Login
                here.</a>
        </form>
    </div>

    <!-- LOGIN SCREEN -->

    <div id="loginUI" class="container">
        <form class="col-md-6 mx-auto" onsubmit="login(); return false;">
            <h4 class="pb-2">Login</h4>
            <div class="form-group">
                <input type="text" id="username" placeholder="Enter your name ..." class="form-control">
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Password" class="form-control">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Login</button>
            </div>
            <a href="#" onclick="showRegistrationScreen();hideLoginScreen()">Don't have an account? Register
                here!</a>
        </form>
    </div>

    <!-- CHAT SCREEN -->

    <div id="chatUI" style="display:none;">
        <div class="d-flex flex-row" style="height: 100%;">

            <!-- SIDEBAR/USER LIST -->

            <div class="col-3">
                <button class="btn btn-primary mb-3" onclick="hideMessageForm(); showGroupForm();">New Group</button>
                <div class="list-group" id="userList">
                    <div class="list-group-item active" data-toggle="list"
                        onclick="recipient = 'all'; groupRecipient = false;">All Users</div>
                </div>
                <div class="list-group" id="groupList">
                </div>
                <button type="button" id="logoutbutton" class="btn btn-primary mt-3" onclick="logout()"> Logout
                </button>
            </div>

            <!-- MAIN AREA -->

            <div class="col-9">

                <!-- MESSAGE SCREEN -->

                <div id="messageForm">
                    <form onsubmit="sendmessage(); return false;">
                        <!-- <form> -->
                        <div class="form-group">
                            <label>Your message:</label>
                            <div class="input-group">
                                <input type="text" oninput="typing()" id="yourmessage"
                                    placeholder="Enter your message ..." class="form-control">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Send</button>
                                </div>
                            </div>
                        </div>
                        <p id="typingMessage"></p>
                    </form>
                    <div id="messages"></div>
                </div>

                <!-- CREATE GROUP SCREEN -->

                <form id="createGroup" style="display: none;"
                    onsubmit="createGroup(); hideGroupForm(); showMessageForm(); return false;">
                    <div class="form-group">
                        <label for="userSelect">Add Users to Group</label>
                        <select multiple id="userSelect" class="form-control" name="user">
                            <!-- <option value="all" selected>All</option> -->
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-group">
                            <label for="groupName">Enter Group Name</label>
                            <input type="text" id="groupName" placeholder="Enter Group Name ..." class="form-control">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" type="submit">Create Group</button>
                        </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FOOTER -->

    <p id="subtitle" class="lead pl-3 fixed-bottom">Developed by Justen Stall, Dena Schaeffer, Beth Hosek, and Jacob
        Scheetz in CPS490</p>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
        </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
        </script>
</body>

</html>